# Disable automatic directory redirection to prevent loops and trailing slash enforcement
<IfModule mod_dir.c>
  DirectorySlash Off
</IfModule>

<IfModule mod_rewrite.c>
  RewriteEngine On

  # 1. Force HTTPS
  RewriteCond %{HTTPS} off
  RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

  # 2. Force non-WWW
  RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
  RewriteRule ^ https://%1%{REQUEST_URI} [L,R=301]

  # 3. Remove trailing slash (Redirect /folder/ to /folder)
  # BUT ensure we don't break directories that need index.html unless the .html file exists at root
  RewriteCond %{REQUEST_URI} ^(.+)/$
  RewriteRule ^ %1 [L,R=301]
  # 4. Remove .html extension (Redirect /page.html to /page)
  RewriteCond %{THE_REQUEST} /([^.]+)\.html [NC]
  RewriteRule ^ /%1 [L,R=301]

  # 5. Internal Rewrite: Serve .html file for extensionless URLs
  # Checks if matching .html file exists, even if a directory with same name exists
  RewriteCond %{REQUEST_FILENAME}.html -f
  RewriteRule ^ %{REQUEST_URI}.html [L]

  # 6. Default index for directories
  RewriteCond %{REQUEST_FILENAME} -d
  RewriteCond %{REQUEST_FILENAME}/index.html -f
  RewriteRule ^(.*)$ $1/index.html [L]
  
  # 7. Error Handling
  ErrorDocument 404 /404.html
</IfModule>

# Prevent directory browsing
Options -Indexes

# Set default charset
AddDefaultCharset UTF-8

# Enable compression for better performance
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

